# minifly upper computer
 接收minifly回传图像、可进行飞行控制的上位机

## 串口通信
在编写串口通信工具中，需要实现一个函数，自动找到对应com 口，并且连接该com口，保证后续通信正常作为初始化过程的一部分。

思路：
在win设备管理器中，经常会出现多个com口，但并不是每个com口都是目标设备所链接的。
尝试打开每个com口，输入enter按键，正确的com口，会有ack log返回，表明通信正常否则，没有任何log返回，则判断为非目标设备所连接的com口。

## 读取图像
我们可以发送HTTP请求给指定的URL（统一资源定位符），这个URL就是所谓的网络API，如果请求成功，它会返回HTTP响应，而HTTP响应的消息体中就有我们需要的Jpg格式的数据。

http://192.168.1.1:80/snapshot.cgi?resolution=11&user=admin&pwd=

### WiFi连接
在WINDOWS的WIFI列表中手动切换WIFI时，系统会先断开当前WIFI连接，再连接等待连接的WIFI。在程序中搜索到minifly的WIFI后，不断开当前WIFI连接，直接与minifly建立连接，无需等待，可瞬间完成连接，节约了大约八秒的等待时间。

## paddle框架
华为事件，让国家意识到了技术创新的重要性，paddle作为国产的深度学习框架，根据内部消息，国家成立了一个重点的项目，扶持paddle的发展，避免有一天在科技上再被卡脖子。目前学术界使用的主流深度学习框架为TensorFlow和Pytorch均为美国公司所研发，未来不排除被限制使用的可能。因此，本系统选用国家近两年大力扶持的国产深度学习框架PaddlePaddle。

## 多进程

cv2.VideoCapture无法被序列化报错，转化为numpy数组传入队列
下面是可以被序列化的，反之则是不可序列化的
可以被序列化的类型有：

* None,True 和 False;

* 整数，浮点数，复数;

* 字符串，字节流，字节数组;

* 包含可pickle对象的tuples，lists，sets和dictionaries；

* 定义在moshule顶层的函数：

* 定义在module顶层的内置函数；

* 定义在module顶层的类；

* 拥有__dict__()或__setstate__()的自定义类型；

            if q.qsize():
                q.get()
            q.put(frame)
根据官方文档，Queue.qsize()返回的值不可靠，Queue的大小可能在调用方法和得到结果之间发生变化

## 致谢
感谢降噪耳机让我保持在安静的环境中编程。

## 空心杯电机

调试中发现，当控制信号回中时，飞机向左侧漂移。经测试发现，在电池电压较低的情况下，若飞机向左旋转时忽然停止旋转，机身会向机体左前方倾斜；若飞机突然开始向右旋转，则机身亦会向机体左前方倾斜。故初步推测左前方电机输出动力减弱，即M4电机动力输出减弱。拆解后发现，M2、M3、M4电机均有不同程度的电机底座脱落情况，其中M4电机底座脱落情况最为严重，如图所示。若继续使用故障电机，不仅飞行稳定性受到影响，飞行安全性无法得到保障，甚至会导致MOS管烧掉或者短路。若MOS管发生短路，飞机通电后，电机就会开始旋转，无法接受单片机控制。综上所述，必须对故障电机进行更换。更换电机后，飞行遂恢复正常。![1613393246701](C:\Users\31801\Documents\Tencent Files\318015647\FileRecv\MobileFile\1613393246701.jpg)

## minifly无人机

只有一个扩展接口，无法同时搭载摄像头模块和光流定位模块。搭载摄像头后，minifly续航时间仅为60s。若进行改装，使其同时搭载摄像头模块和光流定位模块，则续航时间将继续下降，不再具有实用意义。在室内基站天线干扰下，遥控距离仅为10m。且飞机图传信号和遥控信号之间亦容易发生互相干扰，导致图传信号连接不上。电机质量不佳，调试十余天，有三个电机的底座发生不同程度的脱落。其中，M4电机动力输出大幅减弱，严重影响飞行稳定性。对控制信号时间间隔要求较高，需要每隔1ms发送一次控制信号。若发送速度过慢，则无法进行有效控制；若发送速度过快，单片机处理速度跟不上，则无法保持自稳，直接坠机。且更新win10系统后，原先的控制程序失效，经测试发现，系统更新后定时器精度下降，休眠一次约15.8ms，无法精确执行1ms休眠。

## Tello无人机

由于minifly无人机缺点较多，性能不佳，故障频发，故本项目将minifly无人机更换为Tello无人机。